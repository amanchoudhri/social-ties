---
output:
  pdf_document: default
  html_document: default
---
# Neighbor Polling Exploration

```{r, echo=T, message=FALSE}
library(dplyr)
```

```{r}
# notebook-level config parameters

# whether averages should
# be calculated using survey weights or not
use_weights <- T
```

```{r}
# load in the wave 10 dataframe
df <- readRDS('dat/wave-10/processed.rds')

if (!use_weights) {
  df$weight <- 1
}
```

## "Friend Group" Polling

<!-- ### Exploratory Analysis -->
<!-- ```{r} -->
<!-- politics_counts <- table(df$friend_group_discuss_politics) -->
<!-- table(df$friend_group_discuss_politics, df$friend_group_pid5) -->
<!-- ``` -->

### Missing Data Plan

Throw out 1. people who don't respond to `friend_group_presvote24`, 2.
those who report not planning on voting.

### Experiment 1: Estimating Friend Group Polling Adjustment

To estimate the "popular vote" going to Trump under friend group polling, we'll
take advantage of the `friend_group_presvote24` variable, which asked:

> Who do you think most of your friends will vote for in the presidential election
> in November?

With answer choices of:

 * Mostly Kamala Harris
 * About evenly split
 * Mostly Donald Trump
 * Mostly would not vote
 * Mostly another candidate
 * Not sure

For this analysis, we'll discard everyone who thinks their friends
won't vote, will vote third party, or aren't sure.

```{r}
knitr::kable(
  table(df$friend_group_presvote24h),
  col.names=c("Friend Group Vote Estimate", "Count")
  )
```

```{r}
include <- !is.na(df$friend_group_presvote24h) & (
  df$friend_group_presvote24h == "Mostly Kamala Harris" |
  df$friend_group_presvote24h == "About evenly split" |
  df$friend_group_presvote24h == "Mostly Donald Trump"
)

print(paste('This excludes', sum(1 - include, na.rm=T), 'people.'))
df_ht_friends <- df[include,]
```

Let's code friend group presidential vote by considering a "Mostly" response
to mean 75%. We can ablate on this later.

```{r}
mostly_meaning <- 0.75
codebook <- c(
  "Mostly Kamala Harris"=1 - mostly_meaning,
  "About evenly split"=0.5,
  "Mostly Donald Trump"=mostly_meaning
)

df_ht_friends$friend_group_presvote24h_coded <- codebook[
  df_ht_friends$friend_group_presvote24h]

knitr::kable(
  table(df_ht_friends$friend_group_presvote24h_coded),
  col.names=c("Estimated Friends Voteshare for Trump", "Count")
  )
```


Now just compute the difference between the average friend group polling result
and the average standard polling result. To compute the standard polling result,
we'll similarly include only individuals report planning to vote either for
Harris or Trump.

```{r}
standard_estimate <- df %>%
  filter(presvote24h %in% c("Kamala Harris", "Donald Trump"))  %>%
  mutate(coded_vote = (presvote24h == "Donald Trump")) %>%
  summarise(est=mean(coded_vote * weight)) %>%
  pull(est)

friend_group_estimate <- mean(
  df_ht_friends$friend_group_presvote24h_coded *
  df_ht_friends$weight
  )

display_digits <- 4
print(paste(
  "Result with standard polling:",
  round(standard_estimate, display_digits)
  ))
print(paste(
  "Result with friend group polling:",
  round(friend_group_estimate, display_digits)
  ))
```

Now we calculate the standard errors of the estimates.

```{r}
library(Hmisc)

tmp <- df %>%
  filter(presvote24h %in% c("Kamala Harris", "Donald Trump"))  %>%
  mutate(coded_vote = (presvote24h == "Donald Trump"))
  
individual_se <- sqrt(wtd.var(tmp$coded_vote, tmp$weight) / sum(tmp$weight))

friend_se <- sqrt(
  wtd.var(df_ht_friends$friend_group_presvote24h_coded, df_ht_friends$weight)
  / sum(df_ht_friends$weight)
  )

print(paste(
  "SE of standard polling:",
  round(individual_se, display_digits)
  ))
print(paste(
  "SE of friend group polling:",
  round(friend_se, display_digits)
  ))
```

### Experiment 1.5: Subset of Respondents
Since we calculate the `individual` estimate and the `friend_group` estimates
from different subsets, we don't have a way to estimate the standard error of
the difference between the two estimates.

In this section, we'll recalculate the estimates from the same subset of
respondents: major-party voters who report their friends as mostly major-party
voters.

```{r}
major_party_df <- df_ht_friends %>%
  filter(presvote24h %in% c("Kamala Harris", "Donald Trump")) %>%
  mutate(coded_vote = (presvote24h == "Donald Trump"))

print(paste("This leaves us with", nrow(major_party_df), "respondents"))
```

Now let's renormalize the survey weights.
```{r}
major_party_df$weight <- major_party_df$weight / mean(major_party_df$weight)
```

```{r}
subset_individual_estimate <- major_party_df %>%
  mutate(coded_vote = (presvote24h == "Donald Trump")) %>%
  summarise(est=mean(coded_vote * weight)) %>%
  pull(est)

subset_friend_estimate <- mean(
  major_party_df$friend_group_presvote24h_coded *
  major_party_df$weight
  )

cat(
  "Subset estimates ----",
  "Results without subsetting in parenthesis.",
  paste0(
    "\nStandard polling: ",
    round(subset_individual_estimate, display_digits),
    " (",
    round(standard_estimate, display_digits),
    ")"
  ),
  paste0(
    "\nFriend group polling: ",
    round(subset_friend_estimate, display_digits),
    " (", round(friend_group_estimate, display_digits), ")"
  ),
  paste(
    "\nSubset difference in standard polling:",
    round(subset_individual_estimate - standard_estimate, display_digits)
  ),
  paste(
    "\nSubset difference in friend group polling:",
    round(subset_friend_estimate - friend_group_estimate, display_digits)
  ),
  sep="\n"
  )
```

Now we can calculate the standard error of the difference between friend group
polling and individual polling.

```{r}
diffs <- major_party_df %>%
  mutate(d = friend_group_presvote24h_coded - coded_vote) %>%
  pull(d)

se <- sqrt(
  wtd.var(diffs, major_party_df$weight)
  / sum(major_party_df$weight)
  )

print(paste("SE:", round(se, display_digits)))
```

This gives the following 95% confidence interval on the difference.

```{r}
diff <- subset_friend_estimate - subset_individual_estimate
cat(
  round(diff, display_digits), "+/- 2se:",
  paste0(
    "[",
    round(diff - (2 * se), display_digits),
    ", ",
    round(diff + (2 * se), display_digits),
    "]"
  ),
  sep=" "
)
```


### Experiment 2: Deviations from PID

Next, we'll compare these polling estimates to the average individual reported
party ID and average estimated friend group party ID.

```{r}
# for now, throw out Independent/Not sure respondents
individual_pid <- df %>%
  filter(collapsed_pid != "Independent/Not sure") %>%
  dplyr::summarize(est=mean((collapsed_pid == "Republican") * weight)) %>%
  pull(est)
```


To compute the friend
group PID estimate, we'll throw out responses from people who reported that they
aren't sure about the party composition of their friends.

```{r}
codebook <- c(
  "All Democrats"= 0,
  "Mostly Democrats" = 1 - mostly_meaning,
  "About evenly split" = 0.5,
  "Mostly Republicans" = mostly_meaning,
  "All Republicans" = 1
  )

friend_group_pid <- df_ht_friends %>%
  filter(friend_group_pid5 != "Not sure") %>%
  mutate(friend_group_pid5_coded=codebook[friend_group_pid5]) %>%
  dplyr::summarize(est=mean(friend_group_pid5_coded * weight)) %>%
  pull(est)
```

```{r}
display_digits <- 4
print(paste(
  "Proportion Republican with standard polling:",
  round(individual_pid, display_digits)
  ))
print(paste(
  "Proportion Republican with friend group polling:",
  round(friend_group_pid, display_digits)
  ))
```

Now we can compute the differences.

```{r}
standard_estimate - individual_pid
```

```{r}
friend_group_estimate - friend_group_pid
```

### Experiment 3: Sensitivity Analysis

Let's check how sensitive this 'neighbor bias' is to the choice of coding
we use for "Mostly ...".

```{r}
# get the average survey weight per response category,
# weighted by the size of the response category
vote_weights <- df_ht_friends %>%
  group_by(friend_group_presvote24h) %>%
  dplyr::summarize(weight=mean(weight), n=n()) %>%
  mutate(p = n / sum(n), weight=p*weight) %>%
  select(friend_group_presvote24h, weight) %>%
  tibble::deframe()

friend_group_poll_est <- function (p) {
  return (
    (1 - p) * vote_weights["Mostly Kamala Harris"] +
    0.5 * vote_weights["About evenly split"] +
    p * vote_weights["Mostly Donald Trump"]
  )
}

mostly_code_options <- seq(0.5, 1, length.out=100)
plot(
  mostly_code_options,
  friend_group_poll_est(mostly_code_options),
  main="Trump Voteshare Poll Estimate by Proportion Parameter",
  xlab="p",
  ylab="Trump Vote Share",
  )
```

```{r}
pid_weights <- df_ht_friends %>%
  group_by(friend_group_pid5) %>%
  dplyr::summarize(weight=mean(weight), n=n()) %>%
  mutate(p = n / sum(n), weight=p*weight) %>%
  select(friend_group_pid5, weight) %>%
  tibble::deframe()

friend_group_pid_est <- function (p) {
  return (
    0 * pid_weights['All Democrats'] +
    (1 - p) * pid_weights["Mostly Democrats"] +
    0.5 * pid_weights["About evenly split"] +
    p * pid_weights["Mostly Republicans"] +
    1 * pid_weights["All Republicans"]
  )
}

plot(
  mostly_code_options,
  friend_group_pid_est(mostly_code_options),
  main="Republican Composition Estimate by Proportion Parameter",
  xlab="p",
  ylab="Republican Composition",
  )
```

Poll adjustment.

```{r}
poll_adjustments <- (
  friend_group_poll_est(mostly_code_options) -
    friend_group_pid_est(mostly_code_options)
  )
plot(
  mostly_code_options,
  poll_adjustments,
  main="Friend Group Poll Adjustment by Proportion Parameter",
  xlab="p",
  ylab="Increase in Trump Voteshare with Friend Poll",
  )
```
Even in the worst case, the friend group poll estimate is correctly pulled
in favor of Trump.
```{r}
poll_adjustments[length(poll_adjustments)]
```

<!-- ### Experiment 4: Individual-Level Analysis -->

<!-- For each person, we'll compute the following differences: -->

<!-- $$ -->
<!-- \text{pid}_\text{self} - \text{pid}_\text{friends}, \quad \text{and} \quad -->
<!-- \text{vote}_\text{self} - \text{vote}_\text{friends}. -->
<!-- $$ -->

<!-- Regressing these differences on each other, we can get a sense -->
<!-- for  -->

<!-- ## "Best Friend" Polling -->
<!-- ### Experiment 1: Estimating Best Friend Polling Adjustment -->
<!-- For another estimate of the "popular vote" going to Trump under neighbor -->
<!-- polling, we'll take advantage of the `best_friend_group_presvote24` variable -->
<!-- from wave 6, which asked: -->

<!-- > Who do you think [your closest friend] will vote for in the presidential election in November? -->

<!-- With answer choices: -->

<!--  * Joe Biden -->
<!--  * Donald Trump -->
<!--  * Robert F. Kennedy, Jr. -->
<!--  * Jill Stein -->
<!--  * Cornel West -->
<!--  * Other -->
<!--  * Would not vote -->
<!--  * Not sure -->

<!-- For a first analysis, we'll discard everyone who reported their best friends -->
<!-- would vote for anyone other than Biden or Trump. -->

<!-- ```{r} -->
<!-- # df <- readRDS('dat/week-6/processed.rds') -->
<!-- # include <- ( -->
<!-- #   df$best_friend_presvote24 == "Joe Biden" | -->
<!-- #   df$best_friend_presvote24 == "Donald Trump" -->
<!-- # ) -->
<!-- # df <- df[include,] -->
<!-- ``` -->

<!-- From this, we can simply calculate the difference in means of reported 2024 vote -->
<!-- among -->