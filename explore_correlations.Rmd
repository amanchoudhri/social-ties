---
author: "Aman Choudhri"
date: "2024-09-09"
params:
  categorical_var:
    value: 'friend_group_copartisanship'
  cat_var_display_name:
    value: 'Friend Group Copartisanship'
  img_dir:
    value: 'img/friend_group_pid5/'
  base_dir:
    value: '/Users/amanchoudhri/aman/penumbra/notebooks/'
  output_mode:
    value: 'pdf'
output:
  pdf_document: 
    fig_height: 5
  github_document:
    html_preview: false
title: "Explore Correlations with `r params$cat_var_display_name`"
editor_options: 
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dpi=300,fig.width=7)

if (params$output_mode == 'github') {
  base.dir <- '/Users/amanchoudhri/aman/penumbra/'
  base.url <- '/'
  
  knitr::opts_knit$set(base.dir=params$base_dir)
  knitr::opts_chunk$set(fig.path = params$img_dir)
}
```

```{r libraries, echo=F, message=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
```

```{r}
CLEANED_DATA_FILENAME <- 'dat/processed.rds'

df <- readRDS(CLEANED_DATA_FILENAME)
```

Save some instance variables for use in the notebook based on the specified plot
variable, ``r params$categorical_var``.
```{r declare-cat-var}
outcome_var <- params$categorical_var
outcome_var_name <- params$cat_var_display_name
```

```{r, make-plot, echo=F}
bar_plot_base <- function(
    data,
    categorical_plot_var,
    categorical_plot_var_name,
    group_var1,
    group_var2 = NULL
    ) {
  # Ensure categorical_plot_var is a string
  categorical_plot_var <- as.character(categorical_plot_var)
  
  # Drop rows where categorical_plot_var is null
  data <- data[!is.na(df[categorical_plot_var]),]
  
  five_level_partisan_colors <- c("blue", "lightblue", "purple", "pink", "red", "grey")
  five_level_nonpartisan_colors <- c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494', "grey")
  
  color_palettes <- list(
    friend_group_pid3 = c("blue", "purple", "red", "grey"),
    friend_group_pid5 = five_level_partisan_colors,
    friend_group_copartisanship = five_level_nonpartisan_colors,
    # colors created using ColorBrewer 2.0
    # https://colorbrewer2.org/?type=sequential&scheme=YlGnBu&n=5
    friend_group_class = five_level_nonpartisan_colors
  )
  
  # Select the appropriate color palette
  if (!categorical_plot_var %in% names(color_palettes)) {
    stop(paste("No color palette defined for", categorical_plot_var))
  }
  colors <- color_palettes[[categorical_plot_var]]
  
  # Create the grouping expression
  if (is.null(group_var2)) {
    group_vars <- c(as.character(group_var1))
    facet_formula <- as.formula(paste("~", quo_name(group_var1)))
  } else {
    group_vars <- c(as.character(group_var1), as.character(group_var2))
    facet_formula <- as.formula(paste(quo_name(group_var2), "~", quo_name(group_var1)))
  }
  
  # Prepare the data
  plot_data <- data %>%
    group_by(across(all_of(c(group_vars, categorical_plot_var)))) %>%
    summarise(count = n(), .groups = "drop_last") %>%
    mutate(proportion = count / sum(count))
  
  # Create the plot
  p <- ggplot(plot_data, aes(y = !!sym(categorical_plot_var), x = proportion)) +
    geom_bar(stat = "identity", aes(fill = !!sym(categorical_plot_var))) +
    facet_grid(facet_formula) +
    labs(
        title = paste(
          categorical_plot_var_name,
          "by",
          group_var1,
          if(!is.null(group_var2)) paste("and", group_var2)
          ),
         y = categorical_plot_var_name,
         x = "Proportion") +
         # fill = categorical_plot_var_name) +
    scale_x_continuous(labels = scales::percent_format()) +
    scale_y_discrete(limits = rev(levels(plot_data[[categorical_plot_var]]))) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  # Add color scale if colors are provided
  if (!missing(colors)) {
    p <- p + scale_fill_manual(values = colors, guide="none")
  }
  
  return(p)
}
```

Also, since we'll be using these parameters over and over again, define a helper
function so we don't have to repeat code. For more information on the
`bar_plot_base` function, see the appendix at the bottom.
```{r}
bar_plot <- function (group_var1, group_var2=NULL) {
  return(bar_plot_base(df, outcome_var, outcome_var_name, group_var1, group_var2))
}
dot_plot <- function (group_var1, group_var2=NULL) {
  return(dot_plot_base(df, outcome_var, outcome_var_name, group_var1, group_var2))
}
```

## By Personal Party ID

Start by plotting ``r params$categorical_var`` by a person's individual party ID.

```{r}
bar_plot('collapsed_pid')
```

Revisualize in dot plot format if the outcome measure supports it.
```{r dot-plot, echo=F}
dot_plot_base <- function(
    data,
    categorical_plot_var,
    categorical_plot_var_name,
    group_var1,
    group_var2 = NULL
  ) {
  # Assume that group_var1 is a party_id-like variable
  colors <- c("Democrat" = "blue", "Independent/Not sure"="grey", "Republican" = "red")
  
  # Create the grouping expression
  if (is.null(group_var2)) {
    group_vars <- c(as.character(group_var1))
  } else {
    group_vars <- c(as.character(group_var1), as.character(group_var2))
    # drop rows where group_var2 is NA
    data <- data %>% filter(!is.na(!!sym(group_var2)))
  }
  
  # Prepare the data
  plot_data <- data %>%
    filter(!is.na(!!sym(categorical_plot_var))) %>%
    group_by(across(all_of(c(group_vars, categorical_plot_var)))) %>%
    summarise(count = n(), .groups = "drop_last") %>%
    mutate(proportion = count / sum(count))
  
  p <- ggplot(plot_data, aes(x = !!sym(categorical_plot_var), y = proportion)) +
    geom_hline(yintercept = 0, linetype = "solid", color = "gray50") +
    geom_point(
      stat = "identity",
      position=position_jitter(width=0.2),
      aes(colour = collapsed_pid),
      size=3,
      ) +
    scale_color_manual(values=colors) +
    scale_y_continuous(labels = scales::percent_format(), expand=expansion(mult=c(0,0.1))) +
    theme_linedraw() +
    theme(
      text = element_text(size=12),
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_line(color = "grey50", linewidth=0.2)
      ) + 
    labs(
        title = paste(
          categorical_plot_var_name,
          if(!is.null(group_var2)) paste("by", group_var2)
          ),
         x = categorical_plot_var_name,
         y = "Proportion") +
    guides(colour=FALSE)
  
  if (!is.null(group_var2)) {
    facet_expr <- as.formula(paste(". ~", quo_name(group_var2)))
    p <- p + facet_grid(facet_expr) + theme(panel.spacing = unit(0.5, "cm"))
  }
  return(p)
}
```

```{r}
should_display_dot <- outcome_var == "friend_group_copartisanship" || outcome_var == "friend_group_class"
```

```{r, pid, eval=should_display_dot}
dot_plot('collapsed_pid')
```
## By Urbanicity

We'll repeat the same plot, now by urbanicity.

```{r}
bar_plot('urbancity')
```

## Personal Party ID and Urbanicity

Now let's interact personal PID and urbanicity.

```{r}
bar_plot('collapsed_pid', 'urbancity')
```

## By State Partisan Leaning

Let's create a rough analysis by state. Splitting states into D, R, and
swing, we'll again display the proportions of friend group party ID.
We'll use data from the Cook Political Report. To simplify the analysis,
we won't consider the congressional districts in Maine and Nebraska
separately. We mark Maine as D, and Nebraska as R.

```{r}
cook_ratings <- read.csv('dat/cook_political_report_ratings.csv')

# remove maine and nebraska's congressional districts
cook_ratings <- cook_ratings[cook_ratings$state %in% state.name,]

# collapse "leans" and "likelies" down to hard D/R/Tossup
cook_ratings <- cook_ratings %>%
  mutate(
    category = case_when(
      str_detect(category, "D$") ~ "Democratic",
      str_detect(category, "R$") ~ "Republican",
      TRUE ~ "Tossup"
    ) %>%
      factor(levels = c("Democratic", "Tossup", "Republican"))
  )

# add into the df
df <- merge(df, cook_ratings, by.x='inputstate', by.y='state')
# rename column
df$state_leaning <- df$category
```

First, just plot friend group PID by state leaning.

```{r}
bar_plot('state_leaning')
```

Now repeat, facetting once more by individual PID as well.

```{r}
bar_plot('collapsed_pid', 'state_leaning')
```

```{r, pid_and_state, eval=should_display_dot}
dot_plot('collapsed_pid', 'state_leaning')
```

## By County Partisan Leaning
In `process-data.R`, we impute county information based on the ZIP code
in which the respondent said they currently lived.

We split them into D, R, and swing based on their vote proportions in the 2020
election. Note: Alaska and Rhode island do NOT have sub-state level vote share information
available from the MIT election lab, so we treat the whole state as "County".

```{r}
# created in `county_leanings.Rmd`
county_leanings <- read.csv('dat/county-partisan-leanings.csv')
county_leanings
```

```{r}
# merge these `terciles` in based on state and county name
df <- df %>% mutate(state_upper = toupper(inputstate), county_upper=toupper(county)) %>%
  left_join(
    county_leanings,
    by=c("state_upper"="state", "county_upper"="county_name")
  )

county_leaning_labels <- paste(c("Democrat", "Swing", "Republican"), "County")
df$county_leaning <- factor(county_leaning_labels[df$tercile + 2], levels=county_leaning_labels)
```
```{r}
df %>% select(inputstate, collapsed_pid, state_upper, county_upper, proportion_democrat, county_leaning)
```
```{r}
bar_plot('county_leaning')
```

```{r}
bar_plot('collapsed_pid', 'county_leaning')
```

```{r, pid_and_county, eval=should_display_dot}
dot_plot('collapsed_pid', 'county_leaning')
```

```{r}
copartisanship_mapping <- paste(c("Co-partisan", "Swing", "Counter-partisan"), "County")
df$county_copartisanship <- ifelse(
  df$collapsed_pid == "Democrat",
  copartisanship_mapping[df$tercile + 2],
  rev(copartisanship_mapping)[df$tercile + 2]
)
df$county_copartisanship <- factor(df$county_copartisanship, levels=copartisanship_mapping)
df[df$collapsed_pid == "Independent/Not sure", "county_copartisanship"] <- NA

df %>% select(collapsed_pid, county_leaning, county_copartisanship)
```

```{r, pid_and_county_cop, eval=should_display_dot}
dot_plot('collapsed_pid', 'county_copartisanship')
```

## Appendix

```{r, libraries, eval=F}
```
```{r, make-plot, eval=F}
```
```{r dot-plot, eval=F}
```
